{"ast":null,"code":"var _s = $RefreshSig$();\nimport { useState, useEffect } from 'react';\nimport { supabase, handleSupabaseError, handleSupabaseSuccess } from '../lib/supabase';\nimport { getCoverUrl } from '../utils/imageGenerator';\nexport const useSupabaseBooks = () => {\n  _s();\n  const [books, setBooks] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n\n  // ðŸ“¥ Charger tous les livres\n  const loadBooks = async () => {\n    try {\n      setLoading(true);\n      const {\n        data,\n        error\n      } = await supabase.from('books').select('*').order('created_at', {\n        ascending: false\n      });\n      if (error) throw error;\n      setBooks(data || []);\n      setError(null);\n    } catch (err) {\n      console.error('Erreur chargement:', err);\n      setError(err.message);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // âž• Ajouter un livre\n  const addBook = async book => {\n    try {\n      const {\n        data,\n        error\n      } = await supabase.from('books').insert([book]).select().single();\n      if (error) throw error;\n      setBooks([data, ...books]);\n      return handleSupabaseSuccess(data);\n    } catch (err) {\n      return handleSupabaseError(err);\n    }\n  };\n\n  // âœï¸ Mettre Ã  jour un livre\n  const updateBook = async (bookId, updates) => {\n    try {\n      const {\n        data,\n        error\n      } = await supabase.from('books').update(updates).eq('id', bookId).select().single();\n      if (error) throw error;\n      setBooks(books.map(book => book.id === bookId ? data : book));\n      return handleSupabaseSuccess(data);\n    } catch (err) {\n      return handleSupabaseError(err);\n    }\n  };\n\n  // ðŸ—‘ï¸ Supprimer un livre\n  const deleteBook = async bookId => {\n    try {\n      const {\n        error\n      } = await supabase.from('books').delete().eq('id', bookId);\n      if (error) throw error;\n      setBooks(books.filter(book => book.id !== bookId));\n      return handleSupabaseSuccess();\n    } catch (err) {\n      return handleSupabaseError(err);\n    }\n  };\n\n  // ðŸ“¦ Import multiple avec mise Ã  jour des couvertures en arriÃ¨re-plan\n  const importBooks = async newBooks => {\n    try {\n      // InsÃ©rer les livres avec des couvertures temporaires\n      const {\n        data,\n        error\n      } = await supabase.from('books').insert(newBooks).select();\n      if (error) throw error;\n\n      // Ajouter immÃ©diatement les livres Ã  l'interface\n      setBooks([...data, ...books]);\n\n      // Mettre Ã  jour les couvertures en arriÃ¨re-plan\n      updateCoversInBackground(data);\n      return handleSupabaseSuccess(data);\n    } catch (err) {\n      return handleSupabaseError(err);\n    }\n  };\n\n  // ðŸ–¼ï¸ Mettre Ã  jour les couvertures en arriÃ¨re-plan\n  const updateCoversInBackground = async booksToUpdate => {\n    console.log(`ðŸ”„ Mise Ã  jour de ${booksToUpdate.length} couvertures en arriÃ¨re-plan...`);\n    for (const book of booksToUpdate) {\n      // Chercher une vraie couverture\n      const realCover = await getCoverUrl(book.title);\n\n      // Si on a trouvÃ© une meilleure couverture, mettre Ã  jour\n      if (realCover && realCover !== book.cover) {\n        try {\n          await supabase.from('books').update({\n            cover: realCover\n          }).eq('id', book.id);\n\n          // Mettre Ã  jour localement aussi\n          setBooks(prevBooks => prevBooks.map(b => b.id === book.id ? {\n            ...b,\n            cover: realCover\n          } : b));\n          console.log(`âœ… Couverture mise Ã  jour pour: ${book.title}`);\n        } catch (err) {\n          console.error(`âŒ Erreur mise Ã  jour couverture pour ${book.title}:`, err);\n        }\n      }\n    }\n  };\n\n  // ðŸ—‘ï¸ Tout supprimer\n  const clearAllBooks = async () => {\n    if (!window.confirm('Voulez-vous vraiment supprimer TOUTES vos lectures ?')) {\n      return;\n    }\n    try {\n      const {\n        error\n      } = await supabase.from('books').delete().neq('id', 0);\n      if (error) throw error;\n      setBooks([]);\n      return handleSupabaseSuccess();\n    } catch (err) {\n      return handleSupabaseError(err);\n    }\n  };\n\n  // ðŸ“Š Statistiques\n  const getStats = () => ({\n    total: books.length,\n    finished: books.filter(b => b.status === 'finished').length,\n    reading: books.filter(b => b.status === 'reading').length,\n    stopped: books.filter(b => b.status === 'stopped').length\n  });\n\n  // ðŸ”„ Charger au montage\n  useEffect(() => {\n    loadBooks();\n\n    // ðŸŽ§ Ã‰couter les changements en temps rÃ©el\n    const subscription = supabase.channel('books_changes').on('postgres_changes', {\n      event: '*',\n      schema: 'public',\n      table: 'books'\n    }, payload => {\n      console.log('Changement dÃ©tectÃ©:', payload);\n      loadBooks();\n    }).subscribe();\n    return () => {\n      subscription.unsubscribe();\n    };\n  }, []);\n  return {\n    books,\n    loading,\n    error,\n    addBook,\n    updateBook,\n    deleteBook,\n    clearAllBooks,\n    importBooks,\n    getStats,\n    refreshBooks: loadBooks\n  };\n};\n_s(useSupabaseBooks, \"EGY3pKkAurN47vKRxkkn2C8TkJw=\");","map":{"version":3,"names":["useState","useEffect","supabase","handleSupabaseError","handleSupabaseSuccess","getCoverUrl","useSupabaseBooks","_s","books","setBooks","loading","setLoading","error","setError","loadBooks","data","from","select","order","ascending","err","console","message","addBook","book","insert","single","updateBook","bookId","updates","update","eq","map","id","deleteBook","delete","filter","importBooks","newBooks","updateCoversInBackground","booksToUpdate","log","length","realCover","title","cover","prevBooks","b","clearAllBooks","window","confirm","neq","getStats","total","finished","status","reading","stopped","subscription","channel","on","event","schema","table","payload","subscribe","unsubscribe","refreshBooks"],"sources":["/etudiants/siscol/f/ferna_ji/Bureau/BookTime/src/hooks/useSupabaseBooks.js"],"sourcesContent":["import { useState, useEffect } from 'react';\nimport { supabase, handleSupabaseError, handleSupabaseSuccess } from '../lib/supabase';\nimport { getCoverUrl } from '../utils/imageGenerator';\n\nexport const useSupabaseBooks = () => {\n  const [books, setBooks] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n\n  // ðŸ“¥ Charger tous les livres\n  const loadBooks = async () => {\n    try {\n      setLoading(true);\n      const { data, error } = await supabase\n        .from('books')\n        .select('*')\n        .order('created_at', { ascending: false });\n\n      if (error) throw error;\n      setBooks(data || []);\n      setError(null);\n    } catch (err) {\n      console.error('Erreur chargement:', err);\n      setError(err.message);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // âž• Ajouter un livre\n  const addBook = async (book) => {\n    try {\n      const { data, error } = await supabase\n        .from('books')\n        .insert([book])\n        .select()\n        .single();\n\n      if (error) throw error;\n      \n      setBooks([data, ...books]);\n      return handleSupabaseSuccess(data);\n    } catch (err) {\n      return handleSupabaseError(err);\n    }\n  };\n\n  // âœï¸ Mettre Ã  jour un livre\n  const updateBook = async (bookId, updates) => {\n    try {\n      const { data, error } = await supabase\n        .from('books')\n        .update(updates)\n        .eq('id', bookId)\n        .select()\n        .single();\n\n      if (error) throw error;\n\n      setBooks(books.map(book => book.id === bookId ? data : book));\n      return handleSupabaseSuccess(data);\n    } catch (err) {\n      return handleSupabaseError(err);\n    }\n  };\n\n  // ðŸ—‘ï¸ Supprimer un livre\n  const deleteBook = async (bookId) => {\n    try {\n      const { error } = await supabase\n        .from('books')\n        .delete()\n        .eq('id', bookId);\n\n      if (error) throw error;\n\n      setBooks(books.filter(book => book.id !== bookId));\n      return handleSupabaseSuccess();\n    } catch (err) {\n      return handleSupabaseError(err);\n    }\n  };\n\n  // ðŸ“¦ Import multiple avec mise Ã  jour des couvertures en arriÃ¨re-plan\n  const importBooks = async (newBooks) => {\n    try {\n      // InsÃ©rer les livres avec des couvertures temporaires\n      const { data, error } = await supabase\n        .from('books')\n        .insert(newBooks)\n        .select();\n\n      if (error) throw error;\n\n      // Ajouter immÃ©diatement les livres Ã  l'interface\n      setBooks([...data, ...books]);\n\n      // Mettre Ã  jour les couvertures en arriÃ¨re-plan\n      updateCoversInBackground(data);\n\n      return handleSupabaseSuccess(data);\n    } catch (err) {\n      return handleSupabaseError(err);\n    }\n  };\n\n  // ðŸ–¼ï¸ Mettre Ã  jour les couvertures en arriÃ¨re-plan\n  const updateCoversInBackground = async (booksToUpdate) => {\n    console.log(`ðŸ”„ Mise Ã  jour de ${booksToUpdate.length} couvertures en arriÃ¨re-plan...`);\n    \n    for (const book of booksToUpdate) {\n      // Chercher une vraie couverture\n      const realCover = await getCoverUrl(book.title);\n      \n      // Si on a trouvÃ© une meilleure couverture, mettre Ã  jour\n      if (realCover && realCover !== book.cover) {\n        try {\n          await supabase\n            .from('books')\n            .update({ cover: realCover })\n            .eq('id', book.id);\n          \n          // Mettre Ã  jour localement aussi\n          setBooks(prevBooks => \n            prevBooks.map(b => \n              b.id === book.id ? { ...b, cover: realCover } : b\n            )\n          );\n          \n          console.log(`âœ… Couverture mise Ã  jour pour: ${book.title}`);\n        } catch (err) {\n          console.error(`âŒ Erreur mise Ã  jour couverture pour ${book.title}:`, err);\n        }\n      }\n    }\n  };\n\n  // ðŸ—‘ï¸ Tout supprimer\n  const clearAllBooks = async () => {\n    if (!window.confirm('Voulez-vous vraiment supprimer TOUTES vos lectures ?')) {\n      return;\n    }\n\n    try {\n      const { error } = await supabase\n        .from('books')\n        .delete()\n        .neq('id', 0);\n\n      if (error) throw error;\n\n      setBooks([]);\n      return handleSupabaseSuccess();\n    } catch (err) {\n      return handleSupabaseError(err);\n    }\n  };\n\n  // ðŸ“Š Statistiques\n  const getStats = () => ({\n    total: books.length,\n    finished: books.filter(b => b.status === 'finished').length,\n    reading: books.filter(b => b.status === 'reading').length,\n    stopped: books.filter(b => b.status === 'stopped').length\n  });\n\n  // ðŸ”„ Charger au montage\n  useEffect(() => {\n    loadBooks();\n\n    // ðŸŽ§ Ã‰couter les changements en temps rÃ©el\n    const subscription = supabase\n      .channel('books_changes')\n      .on('postgres_changes', \n        { event: '*', schema: 'public', table: 'books' },\n        (payload) => {\n          console.log('Changement dÃ©tectÃ©:', payload);\n          loadBooks();\n        }\n      )\n      .subscribe();\n\n    return () => {\n      subscription.unsubscribe();\n    };\n  }, []);\n\n  return {\n    books,\n    loading,\n    error,\n    addBook,\n    updateBook,\n    deleteBook,\n    clearAllBooks,\n    importBooks,\n    getStats,\n    refreshBooks: loadBooks\n  };\n};"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}